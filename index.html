<html>
	<head>
		<meta charset="UTF-8">
		<title>Squary Adventure</title>
		<style>
			body {
				background-color: lightblue;
			}
			#main-div {
		     width: 400px;
		     height:330px;
		     margin: 0px auto;
		     margin-top: 70px;
    		 vertical-align: middle;

		   }
		   #title {
		   	text-align: center;
		   	color: #fff;
			text-shadow: 0px 1px 0px #999, 0px 2px 0px #888, 0px 3px 0px #777, 0px 4px 0px #666, 0px 5px 0px #555, 0px 6px 0px #444, 0px 7px 0px #333, 0px 8px 7px #001135;
			font: 60px 'ChunkFiveRegular';
		   }
		</style>
		<!--<script type="text/javascript" src="square.min.js" ></script>-->
		<script type="text/javascript" src="src/Renderer/Renderer.js" ></script>
		<script type="text/javascript" src="src/Collision/CollisionManager.js" ></script>
		<script type="text/javascript" src="src/Game/Scene.js" ></script>
		<script type="text/javascript" src="src/Game/GameObjects.js" ></script>
	</head>
	<body onload='play()'>
		<div id='title'>Squary adventure</div>
		<div id='main-div'>
			<canvas id="mycanvas" width="400" height="330" style="border:1px solid #000;">
				Your browser does not support canvas!
			</canvas>	
		</div>
		<script>

			var direction = {
	            RIGHT : 39,
	            LEFT  : 37,
	            UP    : 38,
	            DOWN  : 40
	        };

	        var sceneWidth = 400, sceneHeight = 330;

			var friction = 1.6;
			var gravity = 0.4;
			var bounce = 7;
			var lifetime = 5; // seconds

			function createFileLoader(file, callback) {
				return new Promise(function(resolve, reject) {
					var xhr = new XMLHttpRequest();
					xhr.open("GET", file);

					xhr.onload = function() {
						if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0)) {
				 			resolve(xhr.responseText);
						}
						else {
							reject(Error("An occured while loading file " + file + ". Status : " + xhr.statusText));
						}
					}

					xhr.onerror = function() {
						reject(Error("An occured while loading file " + file + ". Status : " + xhr.statusText));
					}

					xhr.send(); 
				})
			}

			function play() {
				var gameEnded = false;

				var loader = createFileLoader('level1.json', null);
				loader.then(function(response) {
					var obj = JSON.parse(response);
					var player = SQUARE.createBox(obj.player);

					var lifeBar = SQUARE.createBox({x : player.position.x - 3, y : player.position.y - 15, width : 15, height : 3, fillStyle : "#000000"});
					lifeBar.timeBetweenFrames = (1 / (lifeBar.width / lifetime)) / 2;
					lifeBar.referenceTime = new Date().getDate();

					var looserText = SQUARE.createText({id : 'winnerText', text : 'Perdu! Rejouer? (O)', x : sceneWidth / 2 - 85, y : sceneHeight / 2, font : 'bold 24px cursive sans-serif', isVisible : false, fontColor: 'red'});

					var renderer = SQUARE.getRenderer('mycanvas');

					var scene = SQUARE.createScene();
					scene.activeBorder(true);

					scene.setGradientBackgroundColor({startingColor : 'grey', endingColor : 'lightblue', mode : 'horizontal'});

					scene.addChild(player).addChild(lifeBar).addChild(looserText);
					var boxes = [];
					for (var i = 0; i < obj.boxes.length; i++) {
						var box = SQUARE.createBox(obj.boxes[i]);
						boxes.push(box);
						scene.addChild(box);
					}

					var triangles = [];

					for (var i = 0; i < obj.triangles.length; i++) {
						var triangle = SQUARE.createTriangle(obj.triangles[i]);
						triangles.push(triangle);
						scene.addChild(triangle);
					}

					var circles = [];

					for (var i = 0; i < obj.circles.length; i++) {
						var circle = SQUARE.createCircle(obj.circles[i]);
						circles.push(circle);
						scene.addChild(circle);
					}

					var keyboard = scene.keyboard.create();

					keyboard.when('keydown').then(function(key) {
						if (!scene.isPaused()) {
							if (key.keyCode === direction.RIGHT) {
								player.velX = friction;
							}

							if (key.keyCode === direction.LEFT) {
								player.velX = -friction;
							}

							if (key.keyCode === direction.UP) {
								if (!player.isJumping) {
									player.velY = -bounce;
									player.isJumping = true;
								}
							}
						}

						if (key.keyCode === 79) {
							if (gameEnded) {
								play();
							}
						}
					
						if (key.keyCode === 80) {
							scene.pause();
							pauseText.isVisible = !pauseText.isVisible
						}
					})

					keyboard.when('keyup').then(function(key) {
						if (key.keyCode === direction.RIGHT || key.keyCode === direction.LEFT) {
							player.velX = 0;
						}
					});

					scene.onTick().then(function() {
						lifeBar.position.x = player.position.x - 3;
						lifeBar.position.y = player.position.y - 5;

						var timeForThisFrame = new Date().getTime();
						var timeElapsed = (timeForThisFrame - lifeBar.referenceTime) / 1000;

						if (timeElapsed > lifeBar.timeBetweenFrames) {
							lifeBar.width -= 0.5;
							lifeBar.position.x += 0.5;
							lifeBar.referenceTime = new Date().getTime();
						}

						if (lifeBar.width <= 0) {
							looserText.isVisible = true;
							gameEnded = true;
						}

						if (gameEnded) {
							scene.pause();
						}
					});

					scene.when(player).onCollisionWith(boxes).then(function(info) {
						if (info.where === 'bottom') {
							player.velY = -player.velY;
						}

						if (info.where === 'top') {
							player.isJumping = false;
							player.position.y = info.collisioner.position.y - player.height;
							player.position.x += info.collisioner.velX;
							player.velY = 0;
						}

						if (info.where === 'left') {
							player.isJumping = false;
							player.position.x = info.collisioner.position.x - player.width;
							player.velX = 0;
						}

						if (info.where === 'right') {
							player.isJumping = false;
							player.position.x = info.collisioner.position.x + info.collisioner.width;
							player.velX = 0;
						}
					});

					scene.when(player).onCollisionWith([triangles[0], triangles[1], triangles[2]]).then(function(info) {
						looserText.isVisible = true;
						gameEnded = true;
						scene.pause();
					});

					scene.when(player).onCollisionWith(circles).then(function(info) {
						info.collisioner.isVisible = false;
						player.score += 5;
						if (lifeBar.width < 15) {
							lifeBar.width += 1;
						}
					});

					drawScene();

					function drawScene() {
						renderer.render(scene);

						requestAnimationFrame(drawScene);
					}

					scene.when(player).onCollisionWithBorder().then(function(info) {
					if (info.where === 'borderLeft') {
						player.velX = 0;
						player.position.x = 0;
					}

					if (info.where === 'borderRight') {
						player.velX = 0;
						player.position.x = sceneWidth - player.width;
					}

					if (info.where === 'borderBottom') {
						player.velY = 0;
						player.position.y = sceneHeight - player.height;
						player.isJumping = false;
					}
				});

				}, function(error) {
					console.log(error);
				});

				
			}

		</script>
	</body>
</html>