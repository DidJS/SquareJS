<html>
	<head>
		<meta charset="UTF-8">
		<title>Squary Adventure</title>
		<style>
			body {
				background-color: lightblue;
			}
			#main-div {
		     width: 400px;
		     height:330px;
		     margin: 0px auto;
		     margin-top: 70px;
    		 vertical-align: middle;

		   }
		   #title {
		   	text-align: center;
		   	color: #fff;
			text-shadow: 0px 1px 0px #999, 0px 2px 0px #888, 0px 3px 0px #777, 0px 4px 0px #666, 0px 5px 0px #555, 0px 6px 0px #444, 0px 7px 0px #333, 0px 8px 7px #001135;
			font: 60px 'ChunkFiveRegular';
		   }
		</style>
		<!--<script type="text/javascript" src="square.min.js" ></script>-->
		<script type="text/javascript" src="src/Renderer/Renderer.js" ></script>
		<script type="text/javascript" src="src/Collision/CollisionManager.js" ></script>
		<script type="text/javascript" src="src/Game/Scene.js" ></script>
		<script type="text/javascript" src="src/Game/GameObjects.js" ></script>
	</head>
	<body onload='play()'>
		<div id='title'>Squary adventure</div>
		<div id='main-div'>
			<canvas id="mycanvas" width="400" height="330" style="border:1px solid #000;">
				Your browser does not support canvas!
			</canvas>	
		</div>
		<script>

			var direction = {
	            RIGHT : 39,
	            LEFT  : 37,
	            UP    : 38,
	            DOWN  : 40
	        };

	        var sceneWidth = 400, sceneHeight = 330;

			var friction = 1.6;
			var gravity = 0.4;
			var bounce = 8;

			function createFileLoader(file, callback) {
				return new Promise(function(resolve, reject) {
					var xhr = new XMLHttpRequest();
					xhr.open("GET", file);

					xhr.onload = function() {
						if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0)) {
				 			resolve(xhr.responseText);
						}
						else {
							reject(Error("An occured while loading file " + file + ". Status : " + xhr.statusText));
						}
					}

					xhr.onerror = function() {
						reject(Error("An occured while loading file " + file + ". Status : " + xhr.statusText));
					}

					xhr.send(); 
				})
			}

			function play() {
				var gameEnded = false;

				var loader = createFileLoader('level1.json', null);
				loader.then(function(response) {
					var obj = JSON.parse(response);
					var player = SQUARE.createBox(obj.player);
					var renderer = SQUARE.getRenderer('mycanvas');

					var scene = SQUARE.createScene();
					scene.activeBorder(true);

					scene.setGradientBackgroundColor({startingColor : 'grey', endingColor : 'lightblue', mode : 'horizontal'});

					scene.addChild(player);
					for (var i = 0; i < obj.boxes.length; i++) {
						scene.addChild(SQUARE.createBox(obj.boxes[i]));
					}

					drawScene();

					function drawScene() {
						renderer.render(scene);

						requestAnimationFrame(drawScene);
					}

					scene.when(player).onCollisionWithBorder().then(function(info) {
					if (info.where === 'borderLeft') {
						player.velX = 0;
						player.position.x = 0;
					}

					if (info.where === 'borderRight') {
						player.velX = 0;
						player.position.x = sceneWidth - player.width;
					}

					if (info.where === 'borderBottom') {
						player.velY = 0;
						player.position.y = sceneHeight - player.height;
						player.isJumping = false;
					}
				});

				}, function(error) {
					console.log(error);
				});

				
			}

		</script>
	</body>
</html>